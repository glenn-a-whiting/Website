var loremIpsum = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi nec mauris congue ipsum lacinia commodo in quis leo. Aliquam vel pulvinar odio, et laoreet ante. Aenean blandit orci ut risus mollis, vitae pretium felis porta. Donec imperdiet dui a orci ultricies, id gravida mi pretium. Aenean massa tortor, porttitor in neque sit amet, cursus vestibulum ligula. Praesent at sollicitudin lorem, lacinia commodo diam. Sed auctor interdum ullamcorper. Vestibulum varius ligula quis orci tincidunt, vehicula aliquet elit consequat. Quisque elementum augue id suscipit tristique. Nulla a libero libero. Aenean commodo quis quam sit amet venenatis. Praesent lobortis euismod nibh vel bibendum. Morbi metus mi, fringilla ut orci non, lacinia ultrices nisi. Phasellus quis turpis tortor. Sed iaculis placerat pretium. Nam tristique velit id lorem aliquet maximus. Integer mauris mauris, convallis a turpis eget, gravida tempus purus. Morbi nunc quam, pretium a tincidunt ut, fermentum nec risus. Sed id feugiat nisl. Fusce vitae nulla eu justo vehicula pellentesque id ut arcu. Maecenas et est commodo, tempor leo at, finibus lacus. Ut tristique, ligula ut malesuada ultrices, metus sem viverra nisl, non efficitur erat nisi nec dui. Nunc non cursus mi, vitae ultrices enim. Integer laoreet congue dui sed consequat. In nec imperdiet eros. Sed auctor urna in imperdiet iaculis. Etiam ipsum risus, vulputate in odio quis, vehicula condimentum leo. Fusce vitae dapibus enim. Vivamus efficitur risus at lectus gravida, consequat rhoncus odio convallis. Aliquam ut iaculis turpis. Aenean varius justo eget erat pulvinar, sed luctus dui elementum. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Duis id nibh vitae quam tincidunt commodo sit amet at quam. Aliquam efficitur elit lectus, sed dictum purus mollis a. Praesent quis ante magna. Fusce ultrices sollicitudin turpis. Morbi ut fringilla purus, sit amet pulvinar felis. Aenean auctor, nisi sit amet ullamcorper malesuada, est ligula viverra tellus, a lobortis risus nulla a odio. Etiam tincidunt, tortor id interdum placerat, turpis lacus semper nibh, in tempor neque enim vel eros. Maecenas nec magna sed augue fringilla convallis. Phasellus velit ipsum, convallis et dignissim vitae, tempor sit amet libero. Curabitur imperdiet tortor arcu, nec porta eros scelerisque fermentum. Curabitur a convallis velit, ut mattis quam. Duis maximus in nulla ac suscipit. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean lacinia, nisi eu tempus eleifend, lectus leo feugiat arcu, at pellentesque est lectus a urna. Nulla dictum aliquet leo, id condimentum massa tempor nec. Integer pulvinar bibendum augue sit amet rutrum. Nunc sapien enim, scelerisque at condimentum id, sagittis et arcu. Morbi id rhoncus est, et ultrices mauris. Cras ornare elit id sapien tristique ornare. Suspendisse potenti. Pellentesque vel libero euismod, gravida sem ut, bibendum velit. Quisque gravida facilisis nisl, a ultrices sapien ultrices ac. Vivamus vel mi justo. Phasellus facilisis facilisis molestie. Vestibulum pharetra dui lacus, eu feugiat dolor facilisis et. Cras eu felis ipsum. Etiam dapibus porta varius. Duis nec libero ac nulla consequat vehicula at at sem. Phasellus justo lacus, tristique eu ex non, pretium bibendum ante. Maecenas rhoncus quis justo quis luctus. Donec suscipit, leo sit amet scelerisque lacinia, ante massa ornare augue, a luctus sem nisi ut nisl. In hac habitasse platea dictumst. Morbi varius iaculis eros eu interdum. Suspendisse vel quam pharetra, porttitor augue ut, tempor justo. Praesent dolor odio, rhoncus semper porttitor ac, vestibulum tempus risus. Suspendisse potenti. Vestibulum hendrerit dolor in nibh hendrerit luctus. Sed molestie vitae risus nec blandit. Maecenas tristique laoreet nunc quis volutpat. Pellentesque tempor pulvinar metus sed molestie. Quisque at nisl tristique, malesuada libero pretium, dignissim tortor. Duis finibus faucibus magna, sed vestibulum elit consectetur ut. Curabitur mollis commodo turpis, et tempor ante. Donec aliquam feugiat ante vel faucibus. Sed et nulla vel neque pretium interdum. Aenean condimentum ligula vel lorem varius convallis. Nunc sed molestie neque, ut sollicitudin ante. Pellentesque ultricies metus in finibus elementum. Donec eget mollis arcu. Sed erat mauris, lobortis ac bibendum at, commodo consectetur urna. Nunc a nisi ut magna condimentum commodo vitae quis nisi. Donec mollis dictum nulla, vel faucibus urna elementum in. Etiam dapibus massa a volutpat aliquet. Morbi sed accumsan enim. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Aliquam aliquet in quam vel pulvinar. Maecenas ac odio sapien. Mauris nec lorem non leo tempus condimentum id at mauris. Integer nec urna in erat laoreet pharetra non eget lacus. Nulla non libero nisi. Cras sit amet sollicitudin ipsum. Fusce placerat, justo malesuada pharetra semper, metus risus commodo diam, vel suscipit libero nulla sed ligula. Praesent luctus faucibus ex. Quisque euismod elit eget felis cursus, vel facilisis sapien feugiat. Pellentesque pellentesque tortor purus, eget vestibulum est pretium eget. Duis molestie fermentum eros eget sollicitudin. Donec commodo tellus sed vestibulum tempus. Etiam tempor, enim ac rutrum fringilla, mi metus gravida odio, a sollicitudin arcu turpis sit amet lorem. Donec nec posuere dui. Fusce non magna quis nibh porttitor aliquet. Praesent felis est, gravida at cursus ut, mollis ut mi. Nulla aliquam auctor venenatis. Duis ut tempus velit, sed fringilla augue. Duis eleifend, tellus vel ornare egestas, justo nunc dignissim magna, nec sagittis turpis elit lobortis enim. Proin odio odio, ultricies et erat a, convallis vehicula libero. Sed ac laoreet nisl, at varius orci. Sed neque turpis, commodo non nulla a, posuere vestibulum massa. Curabitur non velit sem. Integer eu pellentesque enim. Suspendisse rhoncus nibh ac posuere volutpat. Quisque sit amet ullamcorper diam. Nam dolor arcu, tincidunt sit amet vestibulum ac, volutpat et libero. Ut bibendum dolor id viverra pharetra. Curabitur euismod tincidunt egestas. Praesent nec magna mollis, commodo nisl sit amet, porttitor massa. Nunc elementum erat ac scelerisque rutrum. Proin eget elementum erat. Sed porttitor ex eget gravida lobortis. Cras nec odio nec nisl interdum consectetur. Phasellus quis condimentum lacus. Quisque pharetra mi turpis, non pretium elit cursus nec. Vivamus ut quam tempor, convallis metus eget, ultricies leo. Donec non auctor dolor.";
var loremPosition = 0; //Nth word to be begin from on next use.

var width;
var height;
var debug;

var settings = {
	"menuPlacement": 0,
	"tool": "selecting"
};

// {"label": "", "extra-classes": "", "extra-attributes":{}, "onclick": "", "value": "", "tooltip": "", "input-type": null}

var menuOptions = {
	"Insert":[
		[
			{"label": "Container", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "insert_container", "tooltip": "insert a container where you click", "input-type": null},
			{"label": "Fluid Container", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "insert_fluid_container", "tooltip": "insert a fluid container where you click", "input-type": null}
		],
		[
			{"label": "Panel", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "insert_panel", "tooltip": "insert a panel where you click", "input-type": null}
		],
		[
			{"label": "Grid ...", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "insert_grid", "tooltip": "", "input-type": null}
		],
		[
			{"label": "List Group ...", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "insert_list_group", "tooltip": "", "input-type": null}
		],
		[
			{"label": "Table ...", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "insert_table", "tooltip": "", "input-type": null}
		]
	],
	"Move Menu":[
		[
			{"label": "Top Left", "extra-classes": "", "extra-attributes":{}, "onclick": "optionsLocation('tl')", "value": "", "tooltip": "", "input-type": null},
			{"label": "Top Center", "extra-classes": "", "extra-attributes":{}, "onclick": "optionsLocation('tc')", "value": "", "tooltip": "", "input-type": null},
			{"label": "Top Right", "extra-classes": "", "extra-attributes":{}, "onclick": "optionsLocation('tr')", "value": "", "tooltip": "", "input-type": null}
		],
		[
			{"label": "Center Left", "extra-classes": "", "extra-attributes":{}, "onclick": "optionsLocation('cl')", "value": "", "tooltip": "", "input-type": null},
			{"label": "Center", "extra-classes": "", "extra-attributes":{}, "onclick": "optionsLocation('c')", "value": "", "tooltip": "", "input-type": null},
			{"label": "Center Right", "extra-classes": "", "extra-attributes":{}, "onclick": "optionsLocation('cr')", "value": "", "tooltip": "", "input-type": null}
		],
		[
			{"label": "Bottom Left", "extra-classes": "", "extra-attributes":{}, "onclick": "optionsLocation('bl')", "value": "", "tooltip": "", "input-type": null},
			{"label": "Bottom Center", "extra-classes": "", "extra-attributes":{}, "onclick": "optionsLocation('bc')", "value": "", "tooltip": "", "input-type": null},
			{"label": "Bottom Right", "extra-classes": "", "extra-attributes":{}, "onclick": "optionsLocation('br')", "value": "", "tooltip": "", "input-type": null}
		]
	],
	"Misc":[
		[
			{"label": "Force Minimum Size", "extra-classes": "", "extra-attributes":{}, "onclick": "toggleMinimum(); toggle(this,true);", "value": "", "tooltip": "", "input-type": null}
		],
		[
			{"label": "Show Boundaries", "extra-classes": "", "extra-attributes":{}, "onclick": "borderize(); toggle(this,true);", "value": "", "tooltip": "", "input-type": null}
		],
		[
			{"label": "Lorem Ipsum", "extra-classes": "", "extra-attributes":{}, "onclick": "useLorem(); toggle(this, true);", "value": "", "tooltip": "", "input-type": null}
		]
	],
	"Style":[
		[
			{"label": "Default", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "", "tooltip": "", "input-type": null},
			{"label": "Basic", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "", "tooltip": "", "input-type": null},
			{"label": "Primary", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "", "tooltip": "", "input-type": null}
		],
		[
			{"label": "Success", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "", "tooltip": "", "input-type": null},
			{"label": "Warning", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "", "tooltip": "", "input-type": null},
			{"label": "Info", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "", "tooltip": "", "input-type": null},
			{"label": "Danger", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "", "tooltip": "", "input-type": null}
		]
	],
	"List group":[
		[
			{"label": "Standard", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "insert_standard_list_group", "tooltip": "", "input-type": null},
			{"label": "Clickable", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "insert_clickable_list_group", "tooltip": "", "input-type": null}
		],
		[
			{"label": "# of Rows", "extra-classes": "", "extra-attributes":{"onchange":"changeCommandDetails('listGroupRowCount',this.value)"}, "onclick": "", "value": "", "tooltip": "", "input-type": "number"}
		]
	],
	"Testing":[
		[
			{"label": "Modal", "extra-classes": "", "extra-attributes":{}, "onclick": "showModal(this,'show_modal')", "value": "", "tooltip": "", "input-type": null}
		]
	],
	"Edit":[
		[
			{"label": "Edit Styles", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "edit_styles", "tooltip": "", "input-type": null},
			{"label": "Edit Classes", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "edit_classes", "tooltip": "", "input-type": null}
		],
		[
			{"label": "Edit Text", "extra-classes": "", "extra-attributes":{}, "onclick": "toggle(this,false)", "value": "edit_text", "tooltip": "", "input-type": null}
		]
	]
};

var activeCommand = "";
var activeCommandDetails = {};
var forceMinimum = false;
var borders = false;
var useLoremIpsum = false;
var fixedClasses = ["every","borderize","peek"]; //classes which cannot be altered, and will be removed upon final file output

var contextElement; // last element clicked, used primarily for modals
var contextData = {};

function afterLoad(element){
	width = element.innerWidth;
	height = element.innerHeight;
	generateOptions();
}

function generateOptions(){
	var root = document.getElementById("options");

	var navPills = document.createElement("UL");
	navPills.className = "nav nav-pills";
	Object.keys(menuOptions).forEach((Category, index) => {
		var li = document.createElement("LI");
		if(index === 0) li.className = "active";

		var li_a = document.createElement("A");
		li_a.setAttribute("data-toggle","pill");
		li_a.setAttribute("href","#option-pane-"+Category.replace(" ","_")); //option-pane-[Category]
		li_a.innerHTML = Category;

		li.appendChild(li_a);
		navPills.appendChild(li);

	});
	root.appendChild(navPills);

	var tabContent = document.createElement("DIV");
	tabContent.className = "tab-content";
	Object.keys(menuOptions).forEach((Category, index) => {
		var menu = menuOptions[Category];

		var tabPane = document.createElement("DIV");
		tabPane.className = "tab-pane fade" + (index === 0 ? " in active" : "");
		tabPane.id = "option-pane-"+Category.replace(" ","_");

		var row = document.createElement("DIV");
		row.className = "row";

		var textCenter = document.createElement("DIV");
		textCenter.className = "text-center";

		var listGroup = document.createElement("DIV");
		listGroup.className = "list-group";

		var heading = document.createElement("A");
		heading.className = "list-group-item list-group-item-info btn";
		heading.setAttribute("onclick","toggleSiblings(this)");
		heading.setAttribute("href","#");
		heading.textContent = Category;
		listGroup.appendChild(heading);

		menu.forEach(menuRow => {
			let mr = document.createElement("DIV");
			mr.className = "row";

			let cf = document.createElement("DIV");
			cf.className = "container-fluid";

			menuRow.forEach(menuButton => {
				var commandBtn;
				if(menuButton["input-type"] == null){
					commandBtn = document.createElement("DIV");
					commandBtn.innerHTML = menuButton.label;

					/*if(menuButton["onclick"].startsWith("showModal(this)")){
						commandBtn.innerHTML += " ...";
						commandBtn.setAttribute("data-toggle","modal");
						commandBtn.setAttribute("data-target","#modal");
					}*/
				}
				else{
					commandBtn = document.createElement("INPUT");
					commandBtn.setAttribute("type",menuButton["input-type"]);
					commandBtn.setAttribute("placeholder",menuButton.label);
				}
				commandBtn.classList.add("col-xs-" + 12 / menuRow.length);
				commandBtn.classList.add("col-sm-" + 12 / menuRow.length);
				commandBtn.classList.add("col-md-" + 12 / menuRow.length);
				commandBtn.classList.add("col-lg-" + 12 / menuRow.length);
				commandBtn.classList.add("btn");
				commandBtn.classList.add("btn-default");
				commandBtn.classList.add("text-center");
				commandBtn.classList.add("option");
				if(menuButton["extra-classes"].length > 0){
					menuButton["extra-classes"].split(" ").forEach(c => {
						commandBtn.classList.add(c);
					});
				}
				if(Object.keys(menuButton["extra-attributes"]).length > 0){
					Object.keys(menuButton["extra-attributes"]).forEach(attrName => {
						var attrValue = menuButton["extra-attributes"][attrName];
						commandBtn.setAttribute(attrName, attrValue);
					});
				}
				commandBtn.setAttribute("value",menuButton.value);
				commandBtn.setAttribute("onclick",menuButton.onclick);
				commandBtn.setAttribute("title",menuButton.tooltip);


				cf.appendChild(commandBtn);
			});

			mr.appendChild(cf);
			listGroup.appendChild(mr);
		});
		textCenter.appendChild(listGroup);
		row.appendChild(textCenter);
		tabPane.appendChild(row);
		tabContent.appendChild(tabPane);
		root.appendChild(tabContent);
	});
}

function mouseMoved(event){
	var x = event.clientX;
	var y = event.clientY;

	var topLeft = document.getElementById("ch1");
	var topRight = document.getElementById("ch2");
	var bottomLeft = document.getElementById("ch3");
	var bottomRight = document.getElementById("ch4");

	topLeft.style.width = x;
	topLeft.style.height = y;
	topLeft.style.left = 0;
	topLeft.style.top = 0;

	topRight.style.width = width - x;
	topRight.style.height = y;
	topRight.style.left = x;
	topRight.style.top = 0;

	bottomLeft.style.width = x;
	bottomLeft.style.height = height - y;
	bottomLeft.style.left = 0;
	bottomLeft.style.top = y;

	bottomRight.style.width = width - x;
	bottomRight.style.height = height - y;
	bottomRight.style.left = x;
	bottomRight.style.top = y;
}

function mousePressed(event){
	var x = event.pageX;
	var y = event.pageY;
}

function screenResized(element){
	width = element.innerWidth;
	height = element.innerHeight;
}

function toggleSiblings(element){
	var siblings = element.parentNode.children;
	for(let i = 0; i < siblings.length; i++){
		let sibling = siblings[i];
		if(sibling != element){
			switch(sibling.style.display){
				case "none":
					sibling.style.display = "block";
					break;
				case "initial":
				default:
					sibling.style.display = "none";
					break;
			}
		}
	}
}

function changeCommandDetails(detail, value=null){
	if(detail.constructor == Object){
		Object.keys(detail).forEach(key => {
			activeCommandDetails[key] = detail[key];
		});
	}
	else{
		activeCommandDetails[detail] = value;
	}
}

function optionsLocation(pos){
	settings.menuPlacement = (settings.menuPlacement + 1) % 4;
	var place = settings.menuPlacement;
	var styles = {
		"tl":"container-fluid options-top-left",
		"tc":"container-fluid options-top-center",
		"tr":"container-fluid options-top-right",
		"cl":"container-fluid options-center-left",
		"c":"container-fluid options-center",
		"cr":"container-fluid options-center-right",
		"bl":"container-fluid options-bottom-left",
		"bc":"container-fluid options-bottom-center",
		"br":"container-fluid options-bottom-right"
	};

	var options = document.getElementById("options");
	options.className = styles[pos];
}

function toggle(element,independant=false,limitRow=false){
	var parent = getParentWithClassName(element,limitRow ? "container-fluid" : "list-group");
	var options = document.getElementsByClassName("option");
	if(independant){
		if(element.classList.contains("active")){
			element.classList.remove("active");
		}
		else{
			element.classList.add("active");
		}
	}
	else{
		for(let i = 0; i < options.length; i++){
			let opt = options[i];
			if(childOf(parent,opt)){
				if(opt.classList.contains("active")){
					opt.classList.remove("active");
				}
			}
		}
		element.classList.add("active");
		activeCommand = element.getAttribute("value");

		var statInd = document.getElementById("status-indicator");
		statInd.innerHTML = "Operation: " + formatName(activeCommand);
		statInd.style.animation = "";
		window.setTimeout(function(){
			statInd.style.animation = "status-indicator-blink 0.5s 1 running";
		},10);
	}
}

function formatName(string){
	var res = "";
	string.split("_").forEach(word => {
		res += word.charAt(0).toUpperCase() + word.slice(1).toLowerCase() + " ";
	});
	return res.slice(0,res.length-1);
}

function showModal(element,context){
	contextElement = element;
	var modal = document.getElementById("modal");
	var title = document.getElementById("modal-title");
	var body = document.getElementById("modal-body");
	var accept = document.getElementById("modal-accept");
	title.innerHTML = formatName(context);
	body.innerHTML = "";
	switch(context){
		case "show_modal":
			body.innerHTML = "This modal dialog's content will change depending on context. <br/> Context is the name seen in the modal dialog's header. <br/><br/> Options with an ellipsis (...) will open up a modal dialog";
			break;
		case "edit_styles":
			body.innerHTML = "";
			var listGroup = document.createElement("UL");
			listGroup.className = "list-group";
			var computedStyles = window.getComputedStyle(element);
			var contextDataKeys = [];

			for (var i = 0; i < computedStyles.length; i++) {
				var key = computedStyles[i];
				var value = computedStyles.getPropertyValue(key);
				contextDataKeys.push(key);

				var li = document.createElement("LI");
				li.className = "list-group-item";

				var row = document.createElement("DIV");
				row.className = "row";

				var containerFluid = document.createElement("DIV");
				containerFluid.className = "container-fluid";

				var leftColumn = document.createElement("DIV");
				leftColumn.className = "col-xs-6 col-sm-6 col-md-6 col-lg-6";
				leftColumn.innerHTML = key;

				var rightColumn = document.createElement("INPUT");
				rightColumn.className = "col-xs-6 col-sm-6 col-md-6 col-lg-6 modal-list-group-item";
				rightColumn.placeholder = value;
				rightColumn.setAttribute("onchange","changeContextData('" + key + "', this.value)");

				containerFluid.appendChild(leftColumn);
				containerFluid.appendChild(rightColumn);
				row.appendChild(containerFluid);
				li.appendChild(row);
				listGroup.appendChild(li);
			}
			body.appendChild(listGroup);
			var tempContextData = {};
			contextDataKeys.forEach(k => {
				tempContextData[k] = null;
			});
			contextData = tempContextData;
			accept.setAttribute("onclick","saveModalData('edit_styles')");
			break;
		case "edit_classes":
			var classes = element.classList;
			var listGroup = document.createElement("UL");
			listGroup.className = "list-group";
			for (var i = 0; i < classes.length; i++) {
				var c = classes[i];
				if(fixedClasses.some(fc => fc == c)) continue;
				var li = document.createElement("LI");
				li.className = "list-group-item";
				li.innerHTML = c;
				listGroup.appendChild(li);
			}
			body.appendChild(listGroup);
			break;
		case "insert_grid":
			var listGroup = document.createElement("UL");
			listGroup.className = "list-group";
			var sizes = ["xs","sm","md","lg"];
			var p = document.createElement("P");
			p.innerHTML = "Click on grey bars to signify a division. Number of divisions must be equal across all grid sizes.";

			for (var i = 0; i < 4; i++) {
				var li = document.createElement("LI");
				var row = document.createElement("DIV");
				var containerFluid = document.createElement("DIV");
				var column = document.createElement("DIV");

				li.className = "list-group-item grid_insertion";
				li.setAttribute("onmousemove","");

				row.className = "row";
				containerFluid.className = "container-fluid";
				column.className = "col-xs-12 col-sm-12 col-md-12 col-lg-12 text-center";
				column.innerHTML = sizes[i];

				containerFluid.appendChild(column);
				row.appendChild(containerFluid);
				li.appendChild(row);
				listGroup.appendChild(li);

				for (var j = 1; j <= 11; j++) {
					let k = (i + 1) + "_" + j;
					contextData[k] = false;
					let div = document.createElement("DIV");
					div.className = "grid_division grid_division_" + j;
					div.setAttribute("onclick","this.classList.toggle('isActive'); gridVerification(); changeContextData('"+k+"',this.classList.contains(\'isActive\'));");
					li.appendChild(div);
				}
			}
			body.appendChild(p);
			body.appendChild(listGroup);
			accept.setAttribute("title","Each size must have the same number of divisions.");
			accept.setAttribute("onclick","saveModalData('insert_grid')");
			break;
		case "insert_list_group":
			body.innerHTML += "<div class='container-fluid'>\
				<div class='row'>\
					<div class='col-xs-6 col-sm-6 col-md-6 col-lg-6 btn btn-default' onclick='changeContextData(\'type\',\'standard\'); toggle(this,true);'>\
						Standard\
					</div>\
					<div class='col-xs-6 col-sm-6 col-md-6 col-lg-6 btn btn-default' onclick='changeContextData(\'type\',\'standard\'); toggle(this,true);'>\
						Clickable\
					</div>\
				</div>\
				<div class='row'>\
					<div class='col-xs-12 col-sm-12 col-md-12 col-lg-12 btn btn-default form-group'>\
						<input class='form-control' type='number' placeholder='ROWS' onchange='changeContextData(\'rows\',this.value)'>\
					</div>\
				</div>\
			</div>";

			contextData = {
				"type": null,
				"rows": 1
			};

			accept.setAttribute("onclick","saveModalData('insert_list_group')");
			break;
		case "insert_table":
			body.innerHTML += "<ul class='list-group'>\
				<li class='list-group-item'>\
					<div class='form-group'>\
						<input class='form-control' type='number' placeholder='Columns' onchange='changeContextData(\"columns\",this.value)'/>\
					</div>\
					<div class='form-group'>\
						<input class='form-control' type='number' placeholder='Rows' onchange='changeContextData(\"rows\",this.value)'/>\
					</div>\
					<form>\
						<div class='checkbox'><label><input type='checkbox' onchange='changeContextData(\"header\")'/>Header Row</label></div>\
						<div class='checkbox'><label><input type='checkbox' onchange='changeContextData(\"striped\")'/>Striped</label></div>\
						<div class='checkbox'><label><input type='checkbox' onchange='changeContextData(\"bordered\")'/>Bordered</label></div>\
						<div class='checkbox'><label><input type='checkbox' onchange='changeContextData(\"mouseover\")'/>Mouse Over Highlight</label></div>\
						<div class='checkbox'><label><input type='checkbox' onchange='changeContextData(\"compact\")'/>Compact</label></div>\
					</form>\
				</li>\
			</ul>";

			contextData = {
				"columns":0,
				"row":0,
				"header":false,
				"striped":false,
				"bordered":false,
				"mouseover":false,
				"compact":false
			};

			accept.setAttribute("onclick","saveModalData('insert_table')");
			break;

		case "edit_text":
			var blocks = innerTextBlocks(element);
			console.log("blocks: ",blocks);
			contextData = {
				"blocks": []
			};
			blocks.forEach((b,i) => {
				body.innerHTML += "<div class='form-group'><textarea class='form-control' rows='4'>" + b + "</textarea></div>";
				if(i !== blocks.length-1) body.innerHTML += "<hr>";
				contextData.blocks.push(b);
			});
			//accept.setAttribute("onclick","saveModalData('edit_text')");
			break;

		default:
			body.innerHTML = "No correct modal context given.";
			break;
	}
	$("#modal").modal("show");
}

function changeContextData(key, value){
	if(value === undefined) contextData[key] = !contextData[key];
	else contextData[key] = value;
}

function gridVerification(){
	var accept = document.getElementById("modal-accept");
	var divs = document.getElementsByClassName("grid_insertion");
	var count;
	var flag = true;
	for(let i = 0; i < divs.length; i++){
		var d = divs[i];
		var children = d.children;
		var tempCount = 0;
		for(let j = 0; j < children.length; j++){
			var c = children[j];
			if(c.classList.contains("isActive")){
				tempCount++;
			}
		}
		if(count == undefined){
			count = tempCount;
		}
		if(tempCount != count){
			flag = false;
			break;
		}
	}

	if(!flag){
		accept.classList.add("disabled");
		accept.style.pointerEvents = "none";
	}
	else{
		accept.classList.remove("disabled");
		accept.style.pointerEvents = "auto";
	}
}

function saveModalData(context){
	switch(context){
		case "edit_styles":
			var inlineStyle = "";
			var existingStyles = contextElement.hasAttribute("style") ? contextElement.getAttribute("style").split(";") : [];
			Object.keys(contextData).forEach(key => {
				let value = contextData[key];
				if (value !== null){
					inlineStyle += key + ":" + value + ";";
				}
				else{
					existingStyles.forEach(style => {
						var s = style.split(":");
						if(s[0] == key){
							inlineStyle += style;
						}
					});
				}
			});
			contextElement.setAttribute("style",inlineStyle);
			break;
		case "insert_grid":
			var column = [];
			var longestColumn = 0;
			for(let i = 1; i <= 4; i++){
				var row = [];
				for(let j = 1, p = 1; j <= 11; j++, p++){
					var key = i + "_" + j;
					var value = contextData[key];
					if(value){
						row.push(p);
						if(j === 11) row.push(1);
						p = 0;
					}
					else if(j === 11) row.push(p+1);
				}
				column.push(row);
				if(row.length > longestColumn) longestColumn = row.length;
			}
			var realColumn = [];
			for(let i = 0; i < longestColumn; i++){
				var realRow = [];
				for(let j = 0; j < 4; j++) realRow.push(column[j][i]);
				realColumn.push(realRow);
			}
			var size = ["xs","sm","md","lg"];
			var newrow = document.createElement("DIV");
			realColumn.forEach(c => {
				var newcolumn = document.createElement("DIV");
				c.forEach((s,i) => {
					newcolumn.classList.add("col-"+size[i]+"-"+s);
				});
				prepareElement(newcolumn);
				newrow.appendChild(newcolumn);
			});
			prepareElement(newrow);
			contextElement.appendChild(newrow);
			break;
		case "insert_list_group":
			if(contextData.type !== null){
				var listGroup;
				switch (contextData.type) {
					case "clickable":
						listGroup = document.createElement("DIV");
						break;
					case "standard":
						listGroup = document.createElement("UL");
						break;
				}
				listGroup.className = "list-group";
				for(let i = 0; i < contextData.rows; i++){
					var item;
					switch(contextData.type){
						case "clickable":
							item = document.createElement("A");
							break;
						case "standard":
							item = document.createElement("LI");
							break;
					}
					item.className = "list-group-item";
					prepareElement(item);
					listGroup.appendChild(item);
				}
				prepareElement(listGroup);
				contextElement.appendChild(listGroup);
			}
			break;
		case "insert_table":
			var table = document.createElement("TABLE");
			table.classList.add("table");
			if(contextData.striped) table.classList.add("table-striped");
			if(contextData.bordered) table.classList.add("table-bordered");
			if(contextData.mouseover) table.classList.add("table-hover");
			if(contextData.compact) table.classList.add("table-condensed");

			var thead = document.createElement("THEAD");
			var tbody = document.createElement("TBODY");

			for(let r = 0 - Number(contextData.header); r < Number(contextData.rows); r++){
				var row = document.createElement("TR");
				for(let c = 0; c < Number(contextData.columns); c++){
					var cell;
					if(r == -1) cell = document.createElement("TH");
					else cell = document.createElement("TD");
					cell.innerHTML = r + "," + c;
					prepareElement(cell);
					row.appendChild(cell);
				}
				prepareElement(row);
				if(r == -1){
					thead.appendChild(row);
				}
				else{
					tbody.appendChild(row);
				}
			}
			if(thead.children.length > 0){
				prepareElement(thead);
				table.appendChild(thead);
			}

			prepareElement(tbody);
			table.appendChild(tbody);

			prepareElement(table);
			contextElement.appendChild(table);
			break;
	}

	//clean up after data is submitted.
	contextElement = undefined;
	contextData = {};
}

function getParentWithClassName(element,name){
	var parent = element.parentNode;
	if(parent == null){
		return null;
	}
	else{
		if(parent.classList.contains(name)){
			return parent;
		}
		else{
			return getParentWithClassName(parent,name);
		}
	}
}

function childOf(parent,child){
	var p = child.parentNode;
	if(p === null){
		return false;
	}
	else if(p == parent){
		return true;
	}
	else{
		return childOf(parent,p);
	}
}

function toggleMinimum(){
	forceMinimum = !forceMinimum;

	var every = document.getElementsByClassName("every");
	for(let i = 0; i < every.length; i++){
		let each = every[i];
		if(forceMinimum){
			each.classList.add("peek");
		}
		else{
			each.classList.remove("peek");
		}
	}
}

function borderize(){
	borders = !borders;

	var every = document.getElementsByClassName("every");
	for(let i = 0; i < every.length; i++){
		let each = every[i];
		if(borders){
			each.classList.add("borderize");
		}
		else{
			each.classList.remove("borderize");
		}
	}
}

// return pairs of matching indexes
// inverting returns indexes of regions between matches
function matchIndexes(text,regex,invert=false){
	var matches = text.match(regex);
	var results = [];
	if(matches !== null){
		for(let offset = 0, m = 0; m < matches.length; m++){
			var match = matches[m];
			var index_a = text.indexOf(match,offset);
			var index_b = index_a + match.length;
			results.push([index_a,index_b]);
			offset = index_b;
		}
		if(invert){
			var temp = [[0]];
			for(let i = 0; i < results.length; i++){
				temp[i].push(results[i][0]);
				temp.push([results[i][1]]);
			}
			temp[temp.length-1].push(text.length-1);
			results = temp;
		}
	}
	return results;
}

// extracts blocks of text between child elements of given element.
function innerTextBlocks(element){
	var text = element.innerHTML;
	var pattern = /<.+?>/g;
	var voidTags = ["area","base","br","col","command","embed","hr","img","input","keygen","link","menuitem","meta","param","source","track","wbr"];
	debug = text;

	var a = [];
	var b = [];
	matchIndexes(text,pattern,false).forEach(p => a.push(text.substring(p[0],p[1])));
	matchIndexes(text,pattern,true).forEach(p => b.push(text.substring(p[0],p[1])));

	if(a.length === 0){
		return [text];
	}
	else {
		var tagSets = {};
		var indexPairs = [];
		var results = [];
		a.forEach((tag,i) => {
			if(Object.keys(tagSets).every(k => tagSets[k] === 0)){
				var s = b[i].trim();
				if(s.length > 0) results.push(s);
			}
			if(voidTags.every(vt => vt !== tag.substr(1,tag.length-2))){
				if(tag.charAt(1) == "/"){
					var t = tag.substr(2,tag.length-3);
					tagSets[t]--;
				}
				else{
					var t = tag.substr(1,tag.length-2).split(" ")[0];
					if(!(t in tagSets)) tagSets[t] = 0;
					tagSets[t]++;
				}
			}
		});
		var s = b[b.length-1].trim();
		if(s.length > 0) results.push(s);

		return results;
	}
}

function useLorem(){
	useLoremIpsum = !useLoremIpsum;
}

function execute(element,event){
	if(event.target == element && element.classList.contains("every")){
		command(element);
	}
}

function prepareElement(newElement){
	newElement.classList.add("every");
	newElement.setAttribute("onclick","execute(this,event)");

	if(borders) newElement.classList.add("borderize");
	if(forceMinimum) newElement.classList.add("peek");
	if(useLoremIpsum) {
		var rand = Math.floor(Math.random()*30)+10;
		newElement.innerHTML += loremIpsum.split(" ").slice(loremPosition,loremPosition+rand).join(" ");
		loremPosition = (loremPosition + rand) % loremIpsum.split(" ").length;
	}
}

function command(element){
	var newElement;
	switch(activeCommand){
		case "insert_container":
			newElement = document.createElement("DIV");
			newElement.className = "container";
			break;
		case "insert_fluid_container":
			newElement = document.createElement("DIV");
			newElement.className = "fluid-container";
			break;
		case "insert_panel":
			newElement = document.createElement("DIV");
			newElement.className = "panel panel-default";
			break;

		case "insert_grid":
			showModal(element,"insert_grid");
			break;

		case "insert_list_group":
			showModal(element,"insert_list_group");
			break;

		case "insert_clickable_list_group":
			newElement = document.createElement("DIV");
			newElement.className = "list-group";
			for(let i = 0; i < activeCommandDetails["listGroupRowCount"]; i++){
				let column = document.createElement("A");
				column.setAttribute("href","#");
				column.className = "list-group-item";
				prepareElement(column);
				newElement.appendChild(column);
			}
			break;
		case "insert_standard_list_group":
			newElement = document.createElement("UL");
			newElement.className = "list-group";
			for(let i = 0; i < activeCommandDetails["listGroupRowCount"]; i++){
				let column = document.createElement("LI");
				column.className = "list-group-item";
				prepareElement(column);
				newElement.appendChild(column);
			}
			break;
		case "edit_styles":
			showModal(element,"edit_styles");
			break;
		case "edit_classes":
			showModal(element,"edit_classes");
			break;
		case "insert_table":
			showModal(element,"insert_table");
			break;
		case "edit_text":
			showModal(element,"edit_text");
			break;
		default:
			break;
	}
	if(newElement !== undefined){
		newElement.classList.add("every");
		newElement.setAttribute("onclick","execute(this,event)");

		if(borders) newElement.classList.add("borderize");
		if(forceMinimum) newElement.classList.add("peek");
		if(useLoremIpsum) {
			var rand = Math.floor(Math.random()*30)+10;
			newElement.innerHTML += loremIpsum.split(" ").slice(loremPosition,loremPosition+rand).join(" ");
			loremPosition = (loremPosition + rand) % loremIpsum.split(" ").length;
		}
		element.appendChild(newElement);
	}
}
